import React from 'react';
import ReactDOM from 'react-dom';
import BaseComponent from 's2s-base-class';
import { CaretDownIconSVG, AlertIconSVG } from 's2s-svg-icons';
import { fromJS } from "immutable";
import defaultComponentStyle from "./styles.js";


class Select extends BaseComponent {
  constructor(props){
      super(props);
      this.displayName = 'Select';
      this.state={
          isOpen: this.props.isOpen,
          hasError: this.props.hasError,
          hover: false,
          itemHovered: undefined,
          selectedItem: this.props.defaultSelectedItem
        };
      this.toggleSelect = this.toggleSelect.bind(this);
      this.selectItem = this.selectItem.bind(this);
      this.handleKeyDownMenu = this.handleKeyDownMenu.bind(this);
      this.handleKeyDownDropDownItem = this.handleKeyDownDropDownItem.bind(this);
      this.onBlurToggle = this.onBlurToggle.bind(this);
      this.onItemHover = this.onItemHover.bind(this);
      this.onMouseOut = this.onMouseOut.bind(this);
      this.handleMouseEnter = this.handleMouseEnter.bind(this);

      this.prefetchStyles();
  }

  componentWillReceiveProps(nextProps) {
    if (nextProps.hasOwnProperty('defaultSelectedItem')) {
      this.setState((prevState, props) => {
          return { ...prevState, selectedItem: nextProps.defaultSelectedItem };
      });
    }
  }

  get value(){
    return this.props.data[this.state.selectedItem];
  }

  getDefaultStyle(styleName, objectPropState)  {
    //console.log('STYLENAME:::::',styleName)
    return defaultComponentStyle(styleName, objectPropState);
  }

  static thumbnail = 'data:image/png;base64,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';

  static displayName = 'Select'

  static propTypes = {
    cbOnClick: React.PropTypes.func,
    cbValueChanged: React.PropTypes.func,
    compStyle: React.PropTypes.object,
    data: React.PropTypes.array,
    defaultSelectedItem: React.PropTypes.number,
    errorText : React.PropTypes.string,
    hasError: React.PropTypes.bool,
    isDisabled : React.PropTypes.bool,
    isOpen: React.PropTypes.bool,
    selectName: React.PropTypes.string, //this prop is for testability
    itemsVisible :  React.PropTypes.number // number of select options visible when select isOpen.
  };

  static defaultProps = {
    cbOnClick: ()=>{console.log('cbOnClick is not defined');},
    cbValueChanged: ()=>{console.log('cbValueChanged is not defined');},
    data: ['first item 1','second item 2'],
    defaultSelectedItem: 0,
    errorText: 'Please select an option from the dropdown',
    hasError: false,
    isDisabled : false,
    isOpen: false,
    itemsVisible: 2
  };

  shouldComponentUpdate(nextProps, nextState) {
    return !fromJS(nextProps).equals(fromJS(this.props)) || !fromJS(nextState).equals(fromJS(this.state));
  }

  toggleSelect(){
    this.setState({ ...this.state, isOpen: !this.state.isOpen, hasError: false });
    setTimeout(()=>{this.props.cbOnClick();}, 0);
  }

  selectItem(i){
    // NOTE: This setTimeout is necessary so that selectedItem in state gets properly set.
    setTimeout(()=>{
      this.setState({ ...this.state, selectedItem: i /*isOpen: !this.state.isOpen*/  }); // NOTE: isOpen was removed because blurToggle and selectItem were both setting state and therefore not closing it.
    }, 0);
    if (this.props.cbValueChanged){
      this.props.cbValueChanged(this.props.data[i]);
    }
  }

  onBlurToggle(){
    if (this.state.isOpen){
      this.setState({ ...this.state, isOpen: !this.state.isOpen});
    }
  }

  handleKeyDownMenu(e){
    switch (e.keyCode){
      case 32: // enter
        this.toggleSelect();
        break;
      case 13: // spacebar
        this.toggleSelect();
        break;
      case 40: // down arrow
        this.toggleSelect();

          e.preventDefault();
          console.log (this.refs['item0']);
          //the down arrow needs to be pressed twice to successfuly move focus to the item in the list
          ReactDOM.findDOMNode(this.refs['item0']).focus();
          this.setState({ ...this.state, isOpen: true}); //this is to combat the quickness of the onblur function causeing the component to close

        break;
    }
  }

  handleKeyDownDropDownItem(e, index){
    switch (e.keyCode){
      case 9: // tab
      case 32: // enter
      case 13: // spacebar
        this.selectItem(index);
        break;
      case 40: // down arrow
        if(ReactDOM.findDOMNode(this.refs['item'+index]).nextSibling){
          //The preventDefault() method cancels the event if it is cancelable // cancelling onBlurToggle
          e.preventDefault();
          // findDOMNode finds dom with specific ref.
          // nextSibling returns the next item
          // focus gives focus to that next item
          ReactDOM.findDOMNode(this.refs['item'+index]).nextSibling.focus();
          this.setState({ ...this.state, isOpen: true}); //this is to combat the quickness of the onblur function causeing the component to close
        }
        break;
      case 38: // up arrow
        if(ReactDOM.findDOMNode(this.refs['item'+index]).previousSibling){
          e.preventDefault();
          ReactDOM.findDOMNode(this.refs['item'+index]).previousSibling.focus();
          this.setState({ ...this.state, isOpen: true}); //this is to combat the quickness of the onblur function causeing the component to close
        }
        break;
    }
  }

  handleMouseEnter() {
    this.setState({...this.state, 'hover': true});
  }

  // handleMouseLeave() {
  //   this.setState({...this.state, 'hover': false});
  // }

  setSelectStyle() {
    let dynamicSelectStates;
    if (this.state.hover) {
      dynamicSelectStates = this.state.isOpen ? {
        ...this.containerStyleHover,
        ...this.containerStyleFocus
      } : this.containerStyleHover;
    } else {
      dynamicSelectStates = this.state.isOpen ? {
        ...this.containerStyle,
        ...this.containerStyleFocus
      } : this.containerStyle;
    }

    if(this.state.hasError) {
      dynamicSelectStates = {
        ...this.containerStyle,
        ...this.containerStyleError
      };
    }
      return dynamicSelectStates;
  }

  onItemHover(item) {
    if(!this.state.hover){
      this.setState({ ...this.state, itemHovered:item, hover: true});
    }
  }

  onMouseOut() {
    if(this.state.hover){
      this.setState({ ...this.state, 'hover': false, itemHovered: undefined});
    }
  }

  renderSelectOptions(){
    let selectItemStyle;
    return this.props.data.map((item, index)=>{
      const divOnMouseOver = ()=>{this.onItemHover(item);};
      const divOnMouseLeave = ()=>{this.onMouseOut(item);};
      const divOnMouseDown = ()=>{this.selectItem(index);};
      const divOnKeyDown = (e)=>{this.handleKeyDownDropDownItem(e, index);};

      if(item === this.state.itemHovered){
        selectItemStyle = {...this.dropDownItem, backgroundColor: this.state.hover ? this.hoverBackgroundColor.backgroundColor : this.dropDownItem.backgroundColor };
      } else {
        selectItemStyle = this.dropDownItem;
      }
      return (
        <div
            className={`option-${index}`}
            data-optionLabel={`${this.props.selectName}-${index}`}
            onMouseOver = {divOnMouseOver}
            onMouseLeave={divOnMouseLeave}
            onMouseDown={divOnMouseDown}
            key={index}
            ref ={'item'+index}
            onKeyDown={divOnKeyDown}
            role="menuitem"
            style = {selectItemStyle}
            tabIndex="0"
        >
        {item}
        </div>
      );
    });
  }

  prefetchStyles(){
    this.dropDown = this.getStyle('dropDown');
    this.menuOptionStyle = this.getStyle('menuOptionStyle');
    this.controlStyle = this.getStyle('controlStyle');
    this.selectStyle = this.getStyle('selectStyle');
    this.svgContainerStyle = this.getStyle('svgContainerStyle');
    this.svgStyles = this.getStyle('svgStyles');
    this.containerStyleHover = this.getStyle('containerStyleHover');
    this.containerStyle = this.getStyle('containerStyle');
    this.dropDownItem = this.getStyle('dropDownItem');
    this.hoverBackgroundColor = this.getStyle('hoverBackgroundColor');
    this.alertStyles = this.getStyle('alertStyles');
    this.alertSVGStyles = this.getStyle('alertSVGStyles');
    this.disabledSelectStyle = this.getStyle('disabledSelectStyle');
    this.containerStyleFocus = this.getStyle('containerStyleFocus');
    this.containerStyleError = this.getStyle('containerStyleError');
  }

  render(){

    const dropdownStyles = this.state.isOpen ? {...this.dropDown, visibility: 'visible'} : {...this.dropDown,
        visibility: 'hidden' };

    let svgStyles;
    if(this.props.isDisabled) {
      svgStyles = {
        ...this.svgStyles,
        fill: '#ced4da'
      };
    } else {
      svgStyles = this.state.isOpen ? {
        ...this.svgStyles,
        fill: '#228ae6'
      } : {...this.svgStyles};
    }

    let displayItems = (
      <div
          className="displayItems"
          style={dropdownStyles}
          ref='list'
      >
          {this.renderSelectOptions()}
      </div>);

    return (
      <div
          className="wrapper"
          style={this.menuOptionStyle}
          onBlur={this.onBlurToggle}
      >
          <div
              className="selectArea"
              data-selectLabel={this.props.selectName}
              style={this.setSelectStyle()}
              onMouseEnter={this.props.isDisabled ? undefined : this.handleMouseEnter}
              onMouseLeave={this.props.isDisabled ? undefined : this.onMouseOut}
          >
            <div style={this.controlStyle} >
                <div
                    aria-label="drop down menu"
                    style={this.props.isDisabled ? this.disabledSelectStyle : this.selectStyle}
                    role="menu"
                    tabIndex="0"
                    className="dropDownMenu"
                    ref = "dropDownMenu"
                    onMouseDown={this.props.isDisabled ? undefined : this.toggleSelect}
                    aria-haspopup='true'
                    onKeyDown={this.props.isDisabled ? undefined : this.handleKeyDownMenu}
                  >
                      <div className="defaultSelectedItem">
                        {this.props.data[this.state.selectedItem]}
                      </div>
                      <span style={this.svgContainerStyle}>
                        <CaretDownIconSVG svgStyle={svgStyles}/>
                      </span>
                </div>
            </div>
          </div>
          {!this.state.hasError ? displayItems :
            (<div className="errorArea" style={this.alertStyles} >
              <AlertIconSVG svgStyle={this.alertSVGStyles}/>
              <div className="errorText">
                  {this.props.errorText}
              </div>
            </div>)
        }
      </div>);
  }
}

export default Select;
